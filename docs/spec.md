### üéØ Unified Homelab Specification (baseline = Rancher Desktop + WSL2)

This synthesises the three design threads ( *k3sbest*, *CoreLab*, *homeArch* ) into one cohesive, conflict-free spec that **extends** your current Rancher Desktop + WSL2 setup without breaking it.
Where tools overlapped, I selected the lighter-weight or better-integrated option for a Windows-hosted homelab.

---

#### 1 ¬∑ Cluster foundation (kept exactly as today)

| Layer                 | Decision                                               | Rationale / Links                                                    |
| --------------------- | ------------------------------------------------------ | -------------------------------------------------------------------- |
| **Host**              | Windows 11 Pro + WSL2                                  | unchanged ‚Äì Dev shell & CLI cockpit only.                            |
| **Kubernetes**        | Rancher Desktop (single K3s control-plane VM)          | Rancher already solves WSL2 quirks, offers GUI & RBAC.               |
| **Ingress**           | Built-in **Traefik** with Let‚Äôs Encrypt (cert-manager) | Lightweight, auto-discovers services, no extra Windows port-proxies. |
| **Load-balancer**     | MetalLB (simple L2)                                    | Needed only if you add extra physical nodes later.                   |
| **Container runtime** | containerd (default in Rancher Desktop)                | Matches K3s defaults.                                                |

---

#### 2 ¬∑ Core ‚ÄúMECE‚Äù platform add-ons

| Category                  | Selected component                                                 | Reason for selection                                                                  |
| ------------------------- | ------------------------------------------------------------------ | ------------------------------------------------------------------------------------- |
| **Cluster management**    | **Rancher** UI                                                     | Already present; provides multi-factor auth & integrates with Argo CD.                |
| **Secrets**               | **HashiCorp Vault** (Raft single-node) + External Secrets Operator | HomeArch requires Vault; ESO lets pods pull secrets at run-time, no plaintext in Git. |
| **GitOps / CD**           | **Argo CD**                                                        | Aligns all manifests & Helm charts, and Rancher UI links into it.                     |
| **CI**                    | GitHub Actions ‚Üí image sign (Cosign)                               | Windows-friendly; tokens issued via Vault OIDC.                                       |
| **Data back-end**         | **Supabase** self-host (Postgres + pgvector + RLS)                 | Central DB layer requested in homeArch.                                               |
| **Auth**                  | **Ory Kratos + Hydra**                                             | Native OIDC ‚Üí Traefik forward-auth; integrates with Supabase RLS.                     |
| **Messaging / Jobs**      | **RabbitMQ + Dramatiq + Chronos**                                  | Matches both CoreLab and homeArch as event fabric.                                    |
| **Observability**         | **Netdata** (node health) + **OTEL Collector ‚Üí LGTM** stack        | Gives traces/logs/metrics without Prometheus overhead.                                |
| **Feature flags**         | **Flagsmith**                                                      | Built-in SDKs, lightweight, no extra DB.                                              |
| **Automation / low-code** | **n8n**                                                            | Used for alerts & backup workflows.                                                   |
| **Password vault**        | **Vaultwarden**                                                    | Human credentials, 2 FA, sits behind Traefik.                                         |

---

#### 3 ¬∑ Developer-experience tooling

* **Nx monorepo** with a custom `@org/nx-homelab-plugin` to scaffold:

  * `service`, `worker`, `infra:stack`, `argo:app`, `secrets:vault:*` generators.
* **Justfile** as the single CLI front-door (`just init`, `just generate`, `just deploy`, `just vault:*`, etc.).
* **uv** (Python 3.12) & **pnpm** (Node LTS) for deterministic deps.
* Cookiecutter templates feed Nx generators, keeping ‚â• 70 % of boiler-plate out of hand-written code.

---

#### 4 ¬∑ Network & access add-ons

* **MetalLB** for L4 service IPs when you add bare-metal nodes.
* **Apache Guacamole** deployed as a Helm chart inside K3s for remote desktops.
* **Homepage** as LAN landing page; entries auto-generated by Nx generator.
* **Runtipi App Store** for one-click self-hosted extras (isolated namespace).
* **MCP Context Forge** for LAN service discovery & context mesh.

---

#### 5 ¬∑ Operations & security guard-rails

* **Vault policies**: one path per app (`kv/apps/<name>/*`), generated by Nx.
* **External Secrets Operator** watches Vault and creates short-TTL K8s secrets.
* **NetworkPolicies** default-deny; only Traefik ingress namespace is exposed.
* **Just doctor / validate** runs lint, type-check, unit tests, Vault policy lint, and confirms Traefik, Argo CD, Vault, ESO are healthy.
* **Back-ups**: pgBackRest for Supabase, Vault Raft snapshots, Vaultwarden encrypted export, all scheduled via Chronos & notified by n8n.

---

#### 6 ¬∑ Implementation phases (1-2 days each)

1. **Foundation** ‚Äì Nx repo, Justfile, Argo CD ‚Äúapp-of-apps‚Äù, ESO install.
2. **Secrets & Core Services** ‚Äì Vault(+warden), Supabase, Ory, Traefik hardening.
3. **Messaging & Observability** ‚Äì RabbitMQ, Dramatiq, Chronos, OTEL ‚Üí LGTM, Netdata dashboards.
4. **Apps & UX** ‚Äì Flagsmith, n8n, Homepage, Guacamole, MCP, Runtipi.
5. **E2E & Hardening** ‚Äì Playwright tests, image signing, backup drills, docs.

Each phase finished when `just validate` and `ArgoCD Sync = Healthy` are both green.

---

#### 7 ¬∑ Alignment with current Rancher Desktop + WSL2 doc

* **No change** to Rancher Desktop install steps, kube-config exposure or Docker/nerdctl workflow.
* All Helm/Kustomize manifests live in Git, **deployed by Argo CD**, never manually via kubectl.
* WSL2 remains only the **CLI cockpit** running your Justfile, Pulumi, and Ansible ‚Äì workloads stay in the Rancher VM.
* Static-IP tricks for WSL2 are **not required** because Traefik and Rancher expose ports on the Windows host automatically.

---

#### 8 ¬∑ What to do next

* Run `just init` (creates Nx workspace, installs ESO & ArgoCD).
* `just vault:init` (initialise, unseal, enable Kubernetes auth).
* `just provision core` (Supabase, Ory, RabbitMQ, OTEL, Vaultwarden, Flagsmith).
* Verify with `just test` then expose services via Traefik Ingress (wildcard `*.lan`).

Once these are green you can safely iterate‚Äîevery new app or tool is only a `just generate ‚Ä¶ && git push` away, keeping the homelab powerful **and** idiot-proof.

---
]
